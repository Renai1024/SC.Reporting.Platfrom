# Miracle Backend 项目完整解析报告

## 📋 项目概览

**项目名称**: Miracle v3.8.8  
**项目类型**: 基于Spring Boot的企业级快速开发框架  
**技术栈**: Spring Boot 3.3.0 + MyBatis + Spring Security + Redis + JWT  
**Java版本**: 编译目标 Java 17，运行环境 Java 21  
**架构模式**: 前后端分离，多模块Maven项目

---

## 🏗️ 项目架构

### 模块结构

项目采用多模块Maven架构，共7个核心模块：

```
miracle-backend/
├── miracle-admin/          # Web服务入口模块（主启动模块）
├── miracle-common/         # 通用工具类模块
├── miracle-framework/      # 核心框架模块（安全、配置、切面）
├── miracle-system/         # 系统管理模块（用户、角色、菜单等）
├── miracle-extra/          # 扩展业务模块（MES、PLM等业务）
├── miracle-quartz/         # 定时任务模块
└── miracle-generator/      # 代码生成器模块
```

### 模块职责详解

#### 1. **miracle-admin** (主启动模块)
- **职责**: Web服务入口，整合所有模块
- **关键文件**:
  - `MiracleApplication.java`: Spring Boot启动类
  - `MiracleServletInitializer.java`: Web容器部署支持
- **配置**: 
  - 端口: 18088
  - 文件上传路径: `D:/miracle/uploadPath`
  - 日志级别: debug

#### 2. **miracle-common** (通用工具模块)
- **职责**: 提供通用工具类、常量、异常处理
- **核心包结构**:
  ```
  common/
  ├── annotation/      # 自定义注解（@Log, @DataScope, @Excel等）
  ├── constant/       # 常量定义
  ├── core/           # 核心类（BaseController, AjaxResult等）
  ├── enums/          # 枚举类
  ├── exception/      # 异常类
  ├── filter/         # 过滤器（XSS防护）
  └── utils/          # 工具类集合
  ```
- **关键功能**:
  - Excel导入导出 (`ExcelUtil`)
  - 文件上传下载 (`FileUploadUtils`)
  - HTTP工具 (`HttpUtils`)
  - 安全工具 (`SecurityUtils`)
  - SQL注入防护 (`SqlUtil`)

#### 3. **miracle-framework** (核心框架模块)
- **职责**: 框架核心配置和功能
- **核心组件**:
  - **安全配置** (`SecurityConfig`): Spring Security + JWT认证
  - **数据源配置** (`DruidConfig`): 多数据源动态切换
  - **Redis配置** (`RedisConfig`): 缓存和Session管理
  - **切面编程**:
    - `DataScopeAspect`: 数据权限控制
    - `DataSourceAspect`: 数据源切换
    - `LogAspect`: 操作日志记录
    - `RateLimiterAspect`: 限流控制
  - **过滤器**:
    - `JwtAuthenticationTokenFilter`: JWT token验证
    - `XssFilter`: XSS攻击防护

#### 4. **miracle-system** (系统管理模块)
- **职责**: 系统基础功能管理
- **核心功能**:
  - 用户管理 (`SysUser`)
  - 角色管理 (`SysRole`)
  - 菜单管理 (`SysMenu`)
  - 部门管理 (`SysDept`)
  - 字典管理 (`SysDictType`, `SysDictData`)
  - 参数配置 (`SysConfig`)
  - 通知公告 (`SysNotice`)
  - 操作日志 (`SysOperlog`)
  - 登录日志 (`SysLogininfor`)

#### 5. **miracle-extra** (扩展业务模块) ⭐
- **职责**: 企业业务扩展功能
- **业务领域**:
  
  **MES制造执行系统相关**:
  - `BizWeldingRecord`: 焊接结果记录
  - `ProdScrewTorque`: 碳化硅自动锁螺丝数据
  - `InspectionRecordMES`: MES检验记录
  - `ProductReportMes`: 产品报表MES
  - `MesBydlabelprint`: 比亚迪标签打印
  - `MesBydlabelscan`: 比亚迪标签扫描
  - `MesQimixingRecord`: 启明星记录
  - `MesWorkshopTranspose`: 车间转置
  
  **PLM产品生命周期管理**:
  - `PlmProject`: PLM项目信息（从Windchill同步）
  - `PlmDataFetchService`: PLM数据定时抓取服务
  
  **物料管理**:
  - `MaterialInfo`: 物料信息
  - `MaterialReceiveNotice`: 物料接收通知
  
  **ERP集成**:
  - `ErpInfo`: ERP信息查询
  
  **第三方集成**:
  - `SunwodaToolingMoldImport`: 欣旺达工装模具导入

#### 6. **miracle-quartz** (定时任务模块)
- **职责**: 定时任务调度管理
- **功能**: 基于Quartz的任务调度，支持在线添加、修改、删除任务

#### 7. **miracle-generator** (代码生成器模块)
- **职责**: 自动生成前后端代码
- **功能**: 根据数据库表结构生成Controller、Service、Mapper、Vue页面等

---

## 🗄️ 数据源配置

### 多数据源架构

项目支持**1主5从**的多数据源配置：

| 数据源 | 类型 | 数据库 | 用途 |
|--------|------|--------|------|
| **master** | MySQL | miracle (192.168.4.240:3306) | 主库，系统核心数据 |
| **slave** | SQL Server | SC (192.168.4.71:1433) | 从库1 |
| **slave2** | SQL Server | SC (192.168.4.69:1433) | 从库2 |
| **slave3** | MySQL | mom_qms (192.168.4.121:3306) | MES对接欣旺达 |
| **slave4** | SQL Server | SancoERP (192.168.4.226:1433) | 纸飞机ERP |
| **slave5** | SQL Server | DataSyncs (192.168.4.226:1433) | 数据同步 |

### 数据源切换机制

- **注解方式**: 使用 `@DataSource(DataSourceType.SLAVE)` 切换数据源
- **动态切换**: 通过 `DynamicDataSourceContextHolder` 在运行时切换
- **默认数据源**: MASTER（主库）

---

## 🔐 安全架构

### 认证授权流程

```
用户登录
  ↓
SysLoginService.login()
  ↓
验证用户名密码
  ↓
生成JWT Token (TokenService.createToken())
  ↓
存储LoginUser到Redis
  ↓
返回Token给前端
```

### JWT Token机制

- **Token存储**: Redis缓存，key格式: `login_tokens:{uuid}`
- **Token有效期**: 30分钟（可配置）
- **自动刷新**: 距离过期不足20分钟时自动刷新
- **Token格式**: `Bearer {token}`

### 权限控制

- **方法级权限**: `@PreAuthorize("@ss.hasPermi('xxx:xxx:xxx')")`
- **数据权限**: `@DataScope` 注解实现数据范围控制
- **匿名访问**: `@Anonymous` 注解标记无需认证的接口

### 安全防护

1. **XSS防护**: `XssHttpServletRequestWrapper` 过滤器
2. **SQL注入防护**: `SqlUtil.filterKeyword()` 关键字过滤
3. **密码加密**: BCrypt加密存储
4. **登录限制**: 密码错误5次锁定10分钟
5. **CSRF防护**: 已禁用（使用JWT无状态认证）

---

## 📡 API设计

### RESTful API规范

- **统一响应格式**: `AjaxResult<T>`
- **分页响应**: `TableDataInfo<T>`
- **统一异常处理**: `GlobalExceptionHandler`

### 主要API模块

#### 1. 系统管理API (`/system/*`)
- `/system/user` - 用户管理
- `/system/role` - 角色管理
- `/system/menu` - 菜单管理
- `/system/dept` - 部门管理
- `/system/dict` - 字典管理
- `/system/config` - 参数配置
- `/system/notice` - 通知公告

#### 2. 监控管理API (`/monitor/*`)
- `/monitor/online` - 在线用户
- `/monitor/job` - 定时任务
- `/monitor/operlog` - 操作日志
- `/monitor/logininfor` - 登录日志
- `/monitor/server` - 服务监控
- `/monitor/cache` - 缓存监控

#### 3. 扩展业务API (`/extra/*`)
- `/extra/mes/report/weld_record` - 焊接结果记录
- `/extra/mes/report/screw_torque` - 锁螺丝数据
- `/extra/mes/report/inspection` - 检验记录
- `/extra/plm/project` - PLM项目信息
- `/extra/material/*` - 物料管理
- `/extra/erp/*` - ERP信息查询

### Swagger文档

- **访问路径**: `/swagger-ui.html`
- **API文档**: `/v3/api-docs`
- **分组配置**: 
  - default: 测试模块
  - base: 基础信息模块
  - report: 报表模块

---

## 🔄 业务流程

### 1. PLM项目数据同步流程

```
定时任务触发
  ↓
PlmDataFetchService.fetchPlmProjectDataDaily()
  ↓
获取Windchill认证Token
  ↓
调用Windchill API获取项目数据
  ↓
解析JSON数据为PlmProject对象
  ↓
清空现有数据
  ↓
分批插入（每批200条）
  ↓
完成同步
```

### 2. 焊接记录批量导入流程

```
前端提交批量数据
  ↓
BizWeldingRecordController.addBatch()
  ↓
BizWeldingRecordServiceImpl.insertBizWeldingRecordBatch()
  ↓
过滤重复记录（根据productCode + weldingTime）
  ↓
设置创建时间和创建人
  ↓
批量插入数据库
```

**⚠️ 发现的问题**: 当前实现存在逻辑错误，过滤后的记录未正确设置时间和创建人。

### 3. 用户登录流程

```
POST /login
  ↓
验证码校验
  ↓
用户名密码验证
  ↓
密码错误次数检查（Redis）
  ↓
密码匹配验证（BCrypt）
  ↓
生成JWT Token
  ↓
存储LoginUser到Redis
  ↓
记录登录日志
  ↓
返回Token
```

---

## 🛠️ 技术特性

### 1. 多数据源动态切换
- 基于AOP的注解式数据源切换
- 支持MySQL和SQL Server混合使用

### 2. 数据权限控制
- 基于部门的数据范围权限
- 支持：全部数据权限、自定义数据权限、本部门数据权限、本部门及以下数据权限、仅本人数据权限

### 3. 操作日志记录
- AOP自动记录操作日志
- 支持操作类型：新增、修改、删除、查询、导出、导入等

### 4. 代码生成器
- 根据数据库表自动生成CRUD代码
- 支持Java、Vue、SQL代码生成

### 5. Excel导入导出
- 基于注解的Excel导入导出
- 支持复杂表头和字典转换

### 6. 定时任务
- 基于Quartz的定时任务调度
- 支持在线管理任务

---

## 📊 数据库设计

### 核心表结构

#### 系统表
- `sys_user` - 用户表
- `sys_role` - 角色表
- `sys_menu` - 菜单表
- `sys_dept` - 部门表
- `sys_dict_type` - 字典类型表
- `sys_dict_data` - 字典数据表
- `sys_config` - 参数配置表
- `sys_oper_log` - 操作日志表
- `sys_logininfor` - 登录日志表

#### 业务表（miracle-extra模块）
- `biz_welding_record` - 焊接结果记录
- `prod_screw_torque` - 锁螺丝数据
- `inspection_record_mes` - MES检验记录
- `product_report_mes` - 产品报表
- `plm_project` - PLM项目信息
- `material_info` - 物料信息
- `material_receive_notice` - 物料接收通知

---

## 🔧 配置说明

### 应用配置 (`application.yml`)

```yaml
# 服务器配置
server:
  port: 18088
  tomcat:
    threads:
      max: 800
      min-spare: 100

# Redis配置
spring:
  data:
    redis:
      host: 192.168.4.191
      port: 6379
      database: 15
      password: sanco@redis

# Token配置
token:
  header: Authorization
  secret: miracledebugthebug
  expireTime: 30

# PLM配置
plm:
  project_task:
    windchill_base_url: http://192.168.4.246/Windchill
    username: wcadmin
    password: wcadmin
```

### 数据源配置 (`application-druid.yml`)

- **连接池**: Druid
- **初始连接数**: 10
- **最小空闲连接**: 10
- **最大连接数**: 20
- **慢SQL记录**: 超过1000ms的SQL

---

## ⚠️ 发现的问题

### 1. 严重问题

#### 逻辑错误 - BizWeldingRecordServiceImpl
**位置**: `miracle-extra/src/main/java/com/miracle/extra/service/impl/BizWeldingRecordServiceImpl.java:77-87`

**问题**: 
- 第77-79行：过滤出`uniqueRecords`（不存在的记录）
- 第80-83行：却对原始列表`bizWeldingRecord`设置时间和创建人
- 第87行：插入的是`uniqueRecords`，但这些记录没有设置`createTime`和`createBy`

**影响**: 批量插入时，新记录缺少创建时间和创建人信息

### 2. 代码质量问题

- **64个Linter警告**:
  - 30+ 未使用的导入
  - 过时API使用（URL构造函数、BigDecimal方法等）
  - Lombok注解警告

### 3. 环境配置问题

- Java版本不匹配：编译目标Java 17，运行环境Java 21
- 建议统一Java版本

### 4. 安全问题

- Token密钥较弱：`miracledebugthebug`
- 建议使用更强的密钥

---

## 📈 性能优化建议

1. **数据库连接池**: 当前配置较保守，可根据实际负载调整
2. **Redis缓存**: 充分利用Redis缓存热点数据
3. **批量操作**: 已实现批量插入，建议优化批量查询
4. **分页查询**: 使用PageHelper分页，避免全表扫描

---

## 🚀 部署说明

### 开发环境
- JDK: 17/21
- Maven: 3.x
- Redis: 6.x+
- MySQL: 8.x
- SQL Server: 2019+

### 打包部署
```bash
mvn clean package
java -jar miracle-admin/target/miracle-admin.jar
```

### 生产环境建议
1. 使用Nginx反向代理
2. 配置HTTPS
3. 启用Redis持久化
4. 配置数据库主从复制
5. 设置日志轮转
6. 配置监控告警

---

## 📝 总结

**项目特点**:
- ✅ 架构清晰，模块化设计良好
- ✅ 功能完善，覆盖企业级应用需求
- ✅ 安全机制健全，支持多数据源
- ✅ 扩展性强，支持业务模块扩展
- ⚠️ 存在少量代码质量问题需要修复

**适用场景**:
- 企业级管理系统
- MES制造执行系统
- PLM产品生命周期管理
- ERP系统集成
- 数据报表系统

---

**报告生成时间**: 2025年  
**项目版本**: Miracle v3.8.8

