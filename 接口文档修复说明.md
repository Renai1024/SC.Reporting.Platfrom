# 生产环境接口文档修复说明

## 问题描述
开发环境能正确访问接口文档，但生产环境部署后接口文档信息不正确。

## 问题原因分析

### 1. 资源路径配置错误 ⚠️ **主要问题**
`ResourcesConfig` 中配置了错误的 Swagger 资源路径：
- **错误配置**: `classpath:/META-INF/resources/webjars/springfox-swagger-ui/`
- **问题**: 项目使用的是 `springdoc-openapi`，但配置指向了 `springfox-swagger-ui` 的路径
- **影响**: 生产环境打包后，静态资源路径找不到，导致 Swagger UI 无法正常加载

### 2. SpringDoc 配置不完整
- 缺少全局包扫描配置
- API 文档路径未显式启用

## 修复内容

### 1. 修复 ResourcesConfig.java

**修复前**:
```java
registry.addResourceHandler("/swagger-ui/**")
    .addResourceLocations("classpath:/META-INF/resources/webjars/springfox-swagger-ui/")
```

**修复后**:
```java
// SpringDoc UI资源路径
registry.addResourceHandler("/swagger-ui/**")
    .addResourceLocations("classpath:/META-INF/resources/webjars/springdoc-openapi-ui/")
    .setCacheControl(CacheControl.maxAge(5, TimeUnit.HOURS).cachePublic());

// SpringDoc API文档路径
registry.addResourceHandler("/v3/api-docs/**")
    .addResourceLocations("classpath:/META-INF/resources/")
    .setCacheControl(CacheControl.maxAge(5, TimeUnit.HOURS).cachePublic());
```

### 2. 优化 application.yml 配置

**新增配置**:
```yaml
springdoc:
  api-docs:
    enabled: true  # 显式启用API文档
  swagger-ui:
    operations-sorter: alpha  # 操作排序
    try-it-out-enabled: true  # 启用"Try it out"功能
  packages-to-scan: com.miracle.web.controller,com.miracle.extra.controller,com.miracle.quartz.controller,com.miracle.generator.controller  # 全局包扫描
```

### 3. 修复 SwaggerConfig.java

**修复前**:
```java
.type(SecurityScheme.Type.APIKEY)  // ❌ 错误类型
.scheme("Bearer")  // ❌ APIKEY类型不支持scheme
```

**修复后**:
```java
.type(SecurityScheme.Type.HTTP)  // ✅ 使用HTTP类型
.scheme("Bearer")
.bearerFormat("JWT")  // ✅ 添加JWT格式说明
```

### 4. 为 Controller 添加 Swagger 注解

为以下 Controller 添加了完整的 Swagger 注解：
- `BizWeldingRecordController` - 添加 `@Tag` 和所有方法的 `@Operation`
- `PlmProjectController` - 添加 `@Tag` 和所有方法的 `@Operation`

## 验证步骤

### 1. 重新打包部署
```bash
mvn clean package
# 部署到生产环境
```

### 2. 访问接口文档
- **Swagger UI**: `http://your-server:port/swagger-ui.html`
- **API 文档**: `http://your-server:port/v3/api-docs`
- **分组文档**: 
  - `http://your-server:port/v3/api-docs/default`
  - `http://your-server:port/v3/api-docs/base`
  - `http://your-server:port/v3/api-docs/report`

### 3. 检查项
- [ ] Swagger UI 页面能正常加载
- [ ] 所有接口分组都能正常显示
- [ ] 接口描述信息完整
- [ ] Bearer Token 认证配置正确
- [ ] 可以正常测试接口

## 可能的问题排查

### 如果仍然无法访问：

1. **检查日志**
   - 查看应用启动日志，确认 SpringDoc 是否正常初始化
   - 查看是否有资源路径相关的错误

2. **检查打包配置**
   - 确认 `springdoc-openapi-ui` 依赖已正确打包
   - 检查 JAR 包中是否包含 `META-INF/resources/webjars/springdoc-openapi-ui/` 路径

3. **检查安全配置**
   - 确认 `SecurityConfig` 中已允许访问 Swagger 相关路径
   - 检查是否有其他过滤器拦截了请求

4. **检查环境变量**
   - 确认生产环境的 `application.yml` 配置正确
   - 检查是否有环境变量覆盖了配置

5. **检查网络/代理**
   - 如果使用 Nginx 等反向代理，确认代理配置正确
   - 检查是否有防火墙规则阻止访问

## 生产环境建议

1. **安全考虑**
   - 建议在生产环境限制 Swagger UI 的访问（仅内网或特定IP）
   - 可以通过 Nginx 配置 IP 白名单

2. **性能优化**
   - 如果不需要 Swagger UI，可以只启用 API 文档：
    ```yaml
    springdoc:
      swagger-ui:
        enabled: false
      api-docs:
        enabled: true
    ```

3. **配置分离**
   - 建议创建 `application-prod.yml` 单独配置生产环境
   - 在 `application.yml` 中设置 `spring.profiles.active: prod`

## 相关文件

- `miracle-framework/src/main/java/com/miracle/framework/config/ResourcesConfig.java`
- `miracle-admin/src/main/java/com/miracle/web/core/config/SwaggerConfig.java`
- `miracle-admin/src/main/resources/application.yml`
- `miracle-extra/src/main/java/com/miracle/extra/controller/BizWeldingRecordController.java`
- `miracle-extra/src/main/java/com/miracle/extra/controller/PlmProjectController.java`

## 修复日期
2025年

